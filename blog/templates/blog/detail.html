{% load humanize %}
{% load staticfiles %}
{% load humanize %}
{% load i18n %}
{% load blog_extras %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src={% static "blog/js/blog.js" %}></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
    <script>

        //页面滚动至回复框
        $(document).ready(function () {
            $("#blog_reply_button").click(function () {
                $('html, body').animate({
                    scrollTop: $("#reply_text").offset().top
                }, 500);
                $("#reply_text").focus();
            });
        });

        //点击以显示楼中楼
        function show_reply(dom, reply_id) {
            var parent = dom.parentNode;
            for (child in parent.childNodes) {
                if (parent.childNodes[child].id == "reply_button") {
                    parent.childNodes[child].style.display = "none";
                }
                if (parent.childNodes[child].id == "hide_reply_index") {
                    parent.childNodes[child].style.display = "block";
                }
            }

            do {
                parent = parent.nextSibling
                if (parent.id == "reply_in_reply") {
                    parent.style.display = "block";
                    break;
                }
            }
            while (parent.nextSibling)


            //获取楼中楼
            if ($(dom.parentNode.parentNode).find("#reply_button").attr("name") == "on") {
                $(dom.parentNode.parentNode).find("#reply_button").attr("name", "off");
                $(dom.parentNode.parentNode).find("#reply_in_reply")[0].innerHTML = '<iframe id="iframe_lzl' + reply_id + '" src="../../replies/' + reply_id + '" frameborder="0" style="padding: 0px; width: 100%; height: 100%;" ></iframe>'
            }

        }

        //ifraim 自适应高度
        function changeheight(id, height) {
            $(id).height(height);
        }

        //点击以隐藏楼中楼
        function hide_replay(dom) {

            var parent = dom.parentNode;
            for (child in parent.childNodes) {
                if (parent.childNodes[child].id == "reply_button") {
                    parent.childNodes[child].style.display = "block";
                }
                if (parent.childNodes[child].id == "hide_reply_index") {
                    parent.childNodes[child].style.display = "none";
                }
            }

            do {
                parent = parent.nextSibling
                if (parent.id == "reply_in_reply") {
                    parent.style.display = "none";
                    break;
                }
            }
            while (parent.nextSibling)

        }


        $(document).ready(function () {

            //POST请求 获取CSRF_Token
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var csrftoken = getCookie('csrftoken');

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            //提交回复
            $("button#subbtn").click(function () {
                var replytext = "";
                for (var i = 0; i < $("#reply_text").contents().length; i++) {
                    if ($("#reply_text").contents()[i].nodeName == "IMG") {
                        replytext += $("#reply_text").contents()[i].outerHTML;
                    }
                    if ($("#reply_text").contents()[i].nodeName == "#text") {
                        replytext += $("#reply_text").contents()[i].data + "\n";
                    }
                    if ($("#reply_text").contents()[i].nodeName == "DIV") {
                        replytext += $("#reply_text").contents()[i].innerText + (($("#blog_text").contents()[i].innerText == "\n") ? "" : "\n");
                    }

                }
                $.ajax({
                    type: "POST",
                    url: "../../replies/",
                    data: JSON.stringify({
                        "blog": "{{ blog.url }}",
                        "reply_text": replytext
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (msg) {
                        window.location.href = msg.blog;
                    }
                });
            });
        });


        $('div[contenteditable]').keydown(function (e) {
            // trap the return key being pressed
            if (e.keyCode === 13) {
                // insert 2 br tags (if only one br tag is inserted the cursor won't go to the next line)
                document.execCommand('insertHTML', false, '<br><br>');
                // prevent the default behaviour of return key pressed
                return false;
            }
        });

        //提交回复
        $(document).ready(function () {

            $("button#reply_the_reply").click(function () {
                $.ajax({
                    type: "POST",
                    url: "../../reply_in_reply/",
                    data: JSON.stringify({
                        "reply": "{{ reply.url }}",
                        "reply_text": $("#reply_in_reply_edit")[0].innerText
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (msg) {
                        window.location.href = msg.blog;
                    }
                });
            });
        });


        $(document).ready(function () {
            var url = window.location.href.split("?")
            for (var i = 1; i <= $(".page").length; i++) {
                if (i == 1) {
                    $(".page a")[i - 1].href = url[0];
                }
                else {
                    $(".page a")[i - 1].href = url[0] + "?page=" + i;
                }
                if ($(".page a")[i - 1].href == window.location.href) {
                    $(".page a")[i - 1].removeAttribute("href");
                }
            }


            var s = $("#blog_text")[0].innerHTML;
            s = s.replaceAll("&gt;", ">");
            s = s.replaceAll("&lt;", "<");
            s = s.replaceAll("\n", "<br/>");
            s = s.replaceAll("&quot;", "'");
            $("#blog_text")[0].innerHTML = s;
            for (var i = 0; i < $(".reply_text").length; i++) {
                var ss = $(".reply_text")[i].innerHTML;
                ss = ss.replaceAll("&gt;", ">");
                ss = ss.replaceAll("&lt;", "<");
                ss = ss.replaceAll("\n", "<br/>");
                ss = ss.replaceAll("&quot;", "'");
                $(".reply_text")[i].innerHTML = ss;
            }


        });


    </script>
    <title>Detail</title>
</head>

<body style="background-color:#e4eaff">

{% include 'blog/navigation.html' %}
<div style="width:800px;margin:0px auto; border:solid 1px #999999; background-color: #ffffff">
    <div style=" border-bottom: solid 1px #000000;">
        <div style="margin-left:20px; margin-right:10px; word-wrap:break-word;">
            <strong>
                <p id="blog_title" style="font-size: 18px; margin: 10px">{{ blog.blog_title }}</p>
            </strong>
        </div>
    </div>
    <div style="overflow:hidden; border-top:none">
        <div style=" min-height:100px; float:left; width:20%;">
            <div style="float:right;"><a>楼主</a><br/>
            </div>
            <div style="text-align:center;">
                <p><img src="" width="100" height="100"
                        style=" border-color:#CCC; border-style:solid;"/></p>
            </div>
            <div style="text-align:center">
                <p><a>{{ blog.user }}</a></p>
            </div>
        </div>
        <div style=" float:left; width:79%; border-left:solid 1px #999999;">
            <div style="margin-left:20px; margin-right:10px; word-wrap:break-word;min-height:200px;">
                <p id="blog_text">{{ blog.blog_text }}</p>
            </div>
            <div style=" margin-left:10px; margin-right:10px;overflow:hidden;">
                <div id="blog_reply_button" style=" float:right;">
                    <p><a>&ensp;回复</a></p>
                </div>
                <div style=" float:right">
                    <p>
                        {{ blog.pub_date|slice:"5:10" }}
                        {{ blog.pub_date|slice:"11:16" }}
                    </p>
                </div>
                <div style=" float:right">
                    <p>1&ensp;楼&ensp;</p>
                </div>
            </div>
            <div id="reply_in_reply" ;
                 style=" overflow:hidden; margin-left:10px; margin-right:10px; margin-bottom:10px;background:#CFF; display:none">
                <div style="overflow:hidden">
                    <div style="float:left; width:10%;"><img
                            src=""
                            width="50px" ; height="50px" ; style="margin:10px"/></div>
                    <div style="float:left;  width:90%">
                        <P style="word-wrap:break-word; min-height:20px;"><a>用户名:</a></P>
                    </div>
                </div>
                <div onclick="show_reply_in_reply_edit(this)" ; style="overflow:hidden">
                    <div style="float:right; border:#999 medium solid; margin:10px; background:#FFF">
                        <p style="padding:0"><a>我也说一句</a></p>
                    </div>
                </div>
                <div id="reply_in_reply_edit" ; style="margin:10px; display:none">
                    <div style="border:#39F 1px solid; background:#FFF">
                        <div style="width: 497px; min-height: 40px; z-index: 0;">
                            <p><span class="at"></span></p>
                        </div>
                        <div style="left: 12px; top: 26px; display: none;">
                            <div class="at_box_title">想用@提到谁？</div>
                            <ul>
                            </ul>
                        </div>
                    </div>
                    <div style="margin:10px">
                        <button style="float:right; margin:10px">发表</button>
                        <span style="float:right;  margin:10px; margin-right:0">
								<div>
                                    <img src="" ; width=20px;
                                         height=20px/>
                                </div>
							</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% for reply in replies.results %}

        <div style="overflow:hidden; border-top:solid 1px #999999; background-color: #ffffff">
            <div style=" min-height:100px; float:left; width:20%;">
                <div style="float:right;"><a>楼主</a><br/>
                </div>
                <div style="text-align:center;">
                    <p><img src="" width="100" height="100" style=" border-color:#CCC; border-style:solid;"/></p>
                </div>
                <div style="text-align:center">
                    <p><a>{{ reply.user }}</a></p>
                </div>
            </div>
            <div style=" float:left; width:79%; border-left:solid 1px #999999;">
                <div style="margin-left:10px; margin-right:10px; word-wrap:break-word;min-height:200px;">
                    <p class="reply_text" id="reply_text">{{ reply.reply_text }}</p>
                </div>
                <div style=" margin-left:10px; margin-right:10px;overflow:hidden;">
                    <div onclick="hide_replay(this)" id="hide_reply_index"
                         style="float:right; background:#CFF; display:none">
                        <p>收起回复</p>
                    </div>
                    <div onclick="show_reply(this, reply_id='{{ reply.id }}')" id="reply_button" style=" float:right;"
                         name="on">
                        <p><a>&ensp;回复({{ reply.reply_counter }})</a></p>
                    </div>
                    <div style=" float:right">
                        <p>
                            {{ reply.pub_date|slice:"5:10" }}
                            {{ reply.pub_date|slice:"11:16" }}
                        </p>

                    </div>
                    <div style=" float:right">
                        <p>{{ reply.floor|add:1 }}&ensp;楼&ensp;</p>
                    </div>
                </div>
                <div id="reply_in_reply" style="display: none">

                </div>
            </div>
        </div>

    {% endfor %}


    <div style="overflow:hidden; padding-left: 10px; padding-top: 10px; margin-bottom: 10px; border-top: solid 1px #000000">
        <div style="float: left; margin-right: 5px">
            {% if replies.previous == None %}
                <a></a>
            {% else %}
                <a href=" {{ replies.previous }} ">上一页</a>
            {% endif %}
        </div>

        {% if replies.count|divide:10 > 1 %}
            {% for i in replies.count|divide:10|list %}
                <div class="page" style="float: left; margin-right: 5px"><a>{{ i }}</a></div>
            {% endfor %}
        {% endif %}

        <div style="float: left; margin-right: 5px">
            {% if replies.next == None %}
                <a></a>
            {% else %}
                <a href="{{ replies.next }}">下一页</a>
            {% endif %}

        </div>
    </div>

    <div style="padding-left: 10px; background-color:#f7f7f7; border-top:1px solid black; border-bottom:1px solid black">

        <div style="margin: 10px">
            <a><strong>发表回复</strong></a>
        </div>

        <div>
            <div style="margin: 10px">
                <div style="width: 90%; border:1px solid black">
                    <div style="margin: 5px; padding-left: 5px">
                        图片 视频 音乐 表情 附件
                    </div>

                    <div>
                        <div>
                            <div id="reply_text_reply" name="reply_text" style="height: 220px;overflow-y: auto;overflow-x: hidden ;z-index: 0; border: solid 1px #999999;
                                background-color: #ffffff; margin: 10px"
                                 contenteditable="true"></div>
                            <div style="display: none;">
                                <div>想用@提到谁？</div>
                                <ul></ul>
                            </div>
                            <div style="display: none;">
                                <div>添加什么话题?</div>
                                <ul></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br/>

        <div>
            <button id="subbtn" title="Ctrl+Enter快捷发表">
                发 表
            </button>
        </div>
        <br/>
    </div>

</div>


</body>
</html>
